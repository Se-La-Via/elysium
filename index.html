<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TON Leaderboard</title>
    <style>
        * { box-sizing: border-box; font-family: Arial, sans-serif; }
        body { max-width: 800px; margin: 0 auto; padding: 20px; }
        h1 { text-align: center; color: #1a73e8; }
        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background-color: #f2f2f2; font-weight: bold; }
        tr:hover { background-color: #f5f5f5; }
        .loader { text-align: center; padding: 20px; }
        .medal-1::before { content: "ü•á "; }
        .medal-2::before { content: "ü•à "; }
        .medal-3::before { content: "ü•â "; }
        .last-update { text-align: center; color: #666; font-size: 0.9em; }
        button { background: #1a73e8; color: white; border: none; padding: 10px 15px; cursor: pointer; }
        button:hover { background: #0d62c9; }
    </style>
</head>
<body>
    <h1>TON Leaderboard</h1>
    <div id="controls">
        <button id="loadData">–ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —Å–µ–π—á–∞—Å</button>
    </div>
    <div id="leaderboard"></div>
    <div id="lastUpdate" class="last-update"></div>

    <script>
        // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
        const API_URL = 'https://dialog-tbot.com/history/ft-transfers/?wallet_id=se_la_via.tg&direction=in&limit=200&skip=0';
        const UPDATE_INTERVAL = 5 * 60 * 1000; // 5 –º–∏–Ω—É—Ç
        const DB_NAME = 'tonTransactionsDB';
        const STORE_NAME = 'transactions';

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
        let db;
        const initDB = new Promise((resolve) => {
            const request = indexedDB.open(DB_NAME, 1);
            
            request.onupgradeneeded = (event) => {
                db = event.target.result;
                if (!db.objectStoreNames.contains(STORE_NAME)) {
                    const store = db.createObjectStore(STORE_NAME, { keyPath: 'id' });
                    store.createIndex('wallet', 'wallet', { unique: false });
                    store.createIndex('timestamp', 'timestamp', { unique: false });
                }
            };

            request.onsuccess = (event) => {
                db = event.target.result;
                resolve();
            };

            request.onerror = (event) => {
                console.error('–û—à–∏–±–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö:', event.target.error);
            };
        });

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
        async function saveTransactions(transactions) {
            return new Promise((resolve) => {
                const tx = db.transaction(STORE_NAME, 'readwrite');
                const store = tx.objectStore(STORE_NAME);
                
                transactions.forEach(transaction => {
                    store.put({
                        id: transaction.id,
                        timestamp: new Date(transaction.timestamp * 1000),
                        wallet: transaction.from,
                        token: transaction.token,
                        amount: parseFloat(transaction.amount)
                    });
                });
                
                tx.oncomplete = () => {
                    resolve(transactions.length);
                };
            });
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ API
        async function fetchTransactions() {
            try {
                const response = await fetch(API_URL, {
                    headers: { 'Accept': 'application/json' }
                });
                
                if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
                
                const data = await response.json();
                return data.transfers || [];
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', error);
                return [];
            }
        }

        // –†–∞—Å—á–µ—Ç –ª–∏–¥–µ—Ä–±–æ—Ä–¥–∞
        async function calculateLeaderboard() {
            return new Promise((resolve) => {
                const tx = db.transaction(STORE_NAME, 'readonly');
                const store = tx.objectStore(STORE_NAME);
                const index = store.index('wallet');
                
                const leaderboard = new Map();
                
                index.openCursor().onsuccess = (event) => {
                    const cursor = event.target.result;
                    if (cursor) {
                        const { wallet, amount } = cursor.value;
                        const current = leaderboard.get(wallet) || 0;
                        leaderboard.set(wallet, current + amount);
                        cursor.continue();
                    } else {
                        // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –∏ –≤—ã–±–æ—Ä —Ç–æ–ø-10
                        const sorted = [...leaderboard.entries()]
                            .sort((a, b) => b[1] - a[1])
                            .slice(0, 10);
                        
                        resolve(sorted);
                    }
                };
            });
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
        async function updateData() {
            document.getElementById('leaderboard').innerHTML = '<div class="loader">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>';
            
            try {
                // –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö
                const transactions = await fetchTransactions();
                await saveTransactions(transactions);
                
                // –†–∞—Å—á–µ—Ç –ª–∏–¥–µ—Ä–±–æ—Ä–¥–∞
                const leaderboard = await calculateLeaderboard();
                
                // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
                renderLeaderboard(leaderboard);
                
                // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏
                document.getElementById('lastUpdate').textContent = 
                    `–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: ${new Date().toLocaleString()}`;
                
            } catch (error) {
                document.getElementById('leaderboard').innerHTML = 
                    `<div class="error">–û—à–∏–±–∫–∞: ${error.message}</div>`;
            }
        }

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ª–∏–¥–µ—Ä–±–æ—Ä–¥–∞
        function renderLeaderboard(data) {
            if (data.length === 0) {
                document.getElementById('leaderboard').innerHTML = '<p>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</p>';
                return;
            }
            
            let html = `
                <table>
                    <thead>
                        <tr>
                            <th>–ú–µ—Å—Ç–æ</th>
                            <th>–ö–æ—à–µ–ª–µ–∫</th>
                            <th>–°—É–º–º–∞ (TON)</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            data.forEach(([wallet, amount], index) => {
                const medalClass = index === 0 ? 'medal-1' : 
                                 index === 1 ? 'medal-2' : 
                                 index === 2 ? 'medal-3' : '';
                
                html += `
                    <tr>
                        <td>${index + 1}</td>
                        <td class="${medalClass}">${wallet}</td>
                        <td>${amount.toFixed(2)}</td>
                    </tr>
                `;
            });
            
            html += `
                    </tbody>
                </table>
            `;
            
            document.getElementById('leaderboard').innerHTML = html;
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        document.addEventListener('DOMContentLoaded', async () => {
            await initDB;
            
            // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
            updateData();
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç
            setInterval(updateData, UPDATE_INTERVAL);
            
            // –ö–Ω–æ–ø–∫–∞ —Ä—É—á–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
            document.getElementById('loadData').addEventListener('click', updateData);
        });
    </script>
</body>
</html>
